# 一文彻底理解分布式事务之TCC ，消息事务，GTS

## TCC
前文我们看到2PC,3PC的设计对数据库的事务耦合性太高，完全可以把分布式事务本身抽象出来，脱离数据库的层面而存在。抽象出来之后提交事务就与数据库事务的提交是两个概念，可以专指我们分布式事务某个子业务本身的完成。
比如 一个典型的支付场景，张三支付给李四1000元的分布式事务问题，可以看做两个子业务张三账户减少1000元 李四账户增加1000元的事务性包装。
这样抽象出来增加一层是计算机重要的思想，我们发现这样抽象出来更灵活了，不再受数据库事务提交后不容易回退回原来状态的限制了，因为完全可以用反向业务 张三账户增加1000元，李四账户减少1000元 来回退。
同时 锁定资源也可以根据业务灵活变通，也脱离的数据库层面对资源的锁定，比如这个转账支付的例子就可以用 业务 冻结张三账号1000元 来作为必要的锁定资源。
这样基于2PC 就有了TCC协议。
如图所示：

![avatar](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1548242071283&di=94c9f0c550d353d82cde63da7b3c185f&imgtype=0&src=http%3A%2F%2Fimage.bubuko.com%2Finfo%2F201808%2F20180822005012945131.png)

同时我们也看到TCC的缺点也很明显，需要大量的业务代码开发支持，对业务的耦合性太高。

## 消息事务
提到消息事务就必须提本地消息，从之前例子我们可以看到一点张三扣款之后李四加钱是允许延迟的，只要张三扣款成功后李四最终保证能加对应的钱就行了，这样我们就可以异步通知李四所在的节点就行了，这就需要消息来控制整体事务，其核心思想是将分布式事务拆分成本地事务进行处理，由消息的发送和消费保证事务的执行。如图所示

需要维持一个本地消息表，保证处于同一个本地数据库事务中，这样业务成功必然有消息数据。通过MQ消息中间件作为分布式事务的协调者，确保消息的发送和最终被消费方处理掉即可保证最终一致性。
![avatar](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1548241686498&di=96487d1b42384f16b24c432c13c9199d&imgtype=0&src=http%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F6807865-cabc7f577be88e9a.png)

缺点： 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。

而消息事务就是脱离数据库事务，使得发送消息可以与业务操作同时成功或失败，主要思路如图
![avatar](http://image20.it168.com/201806_0x0/3205/9e12c05adde28f9f.jpg)

主要思路是发送消息分两步，存消息和确认发送，只有业务成功才确认发送，失败的话根据暂存的消息回退相关业务。

## saga事务模型
无论怎么处理分布式事务，都有难以绕开的难点，因为分布式部署的目的就是为了高并发高可用，而分布式事务的隔离性与高并发是矛盾的。微服务的架构者提出尽量避免使用分布式事务，这时就有了不使用事务模型或者叫1PC模型，而1PC模型最著名和应用最广的是saga事务模型，本质上就是抽出隔离性只关注事务的其他特性的保证。
该模型其核心思想就是拆分分布式系统中的长事务为多个短事务，或者叫多个本地事务，然后由 Sagas 工作流引擎负责协调，如果整个流程正常结束，那么就算是业务成功完成，如果在这过程中实现失败，那么Sagas工作流引擎就会以相反的顺序调用补偿操作，重新进行业务回滚。可以看做去掉T的TCC.
每个 Saga 由一系列 sub-transaction Ti 组成，每个 Ti 都有对应的补偿动作 Ci，补偿动作用于撤销 Ti 造成的结果。这里的每个 T，都是一个本地事务。
Saga 的执行顺序有两种：

T1，T2，T3，...，Tn。

T1，T2，...，Tj，Cj，...，C2，C1，其中 0 < j < n 。

而对隔离性的保证就需要具体业务自己具体处理。

## GTS
阿里号称解决微服务架构分布式事务世界性难题的解决方案。本质上是基于TCC的分布式事务中间件，主要原理在于通过注解的方式低入侵业务代码，通过维护应用级别的日志与锁信息实现了全局事务的回滚与并发控制。

## 参考文献
http://blog.sina.com.cn/s/blog_1403ff9bb0102x8ni.html

https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html

https://blog.couchbase.com/saga-pattern-implement-business-transactions-using-microservices-part/

https://www.cnblogs.com/savorboard/p/distributed-system-transaction-consistency.html

https://www.jianshu.com/p/16b1baf015e8

